<!-- app/templates/predict_product.html -->
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Dự đoán sản phẩm</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>

<body>
    <div class="container">
        <h2>Dự đoán khả năng mua sản phẩm</h2>

        <div class="card">
            <label><b>Chọn file CSV để xem & chọn dòng:</b></label>
            <div class="row">
                <input id="csvInput" type="file" accept=".csv">
                <button id="uploadBtn" class="btn">Tải lên & Xem dữ liệu</button>
            </div>
            <div id="fileInfo" class="muted"></div>
        </div>

        <div id="previewSection" style="display:none">
            <h3>Dữ liệu trong file:</h3>
            <div id="tableWrapper" class="table-scroll">
                <table id="csvTable" class="csv-table">
                    <thead id="csvHead"></thead>
                    <tbody id="csvBody"></tbody>
                </table>
            </div>
            <div class="muted">Kéo bảng để tải thêm. Bấm 1 dòng để tự điền form.</div>
        </div>

        <h3>Thông tin sản phẩm (điền để dự đoán)</h3>
        <form id="predictForm" class="card">
            <div class="grid">
                <select name="searched">
                    <option value="0">Chưa tìm kiếm</option>
                    <option value="1">Đã tìm kiếm</option>
                </select>
                <select name="in_favorite">
                    <option value="0">Không yêu thích</option>
                    <option value="1">Yêu thích</option>
                </select>
                <input name="unit_price" type="number" step="any" placeholder="Giá mỗi đơn vị">

                <input name="original_price" type="number" step="any" placeholder="Giá gốc (original_price)">

                <input name="discount_rate" type="number" step="any" placeholder="% giảm giá (discount_rate)">

                <input name="rating_average" type="number" step="any" placeholder="Điểm đánh giá (rating_average)">

                <input name="review_count" type="number" placeholder="Số đánh giá (review_count)">

                <select name="is_top_brand">
                    <option value="0">Không</option>
                    <option value="1">Có</option>
                </select>

                <select name="is_freeship_xtra">
                    <option value="0">Không</option>
                    <option value="1">Có</option>
                </select>

                <input name="quantity_sold" type="number" placeholder="Số lượng đã bán (quantity_sold)">

                <select name="has_buynow">
                    <option value="0">Không</option>
                    <option value="1">Có</option>
                </select>

                <input name="day_ago_created" type="number" placeholder="Số ngày từ khi tạo (day_ago_created)">

                <input name="qty_clicks" type="number" placeholder="Số lượt click (qty_clicks)">
            </div>

            <button class="btn">Dự đoán</button>
        </form>

        <h3 id="result"></h3>
        <a href="/" class="back">← Quay lại</a>
    </div>

    <script>
        const CHUNK_SIZE = 150;
        let currentFilename = null;
        let totalRows = 0;
        let loadedUntil = 0;
        let loading = false;
        document.getElementById("uploadBtn").addEventListener("click", async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById("csvInput");
            if (!fileInput.files || fileInput.files.length === 0) {
                alert("Chọn file CSV trước.");
                return;
            }
            const file = fileInput.files[0];
            const form = new FormData();
            form.append("file", file);

            document.getElementById("fileInfo").innerText = "Đang tải lên...";

            // upload đúng API
            const infoRes = await fetch("/upload-csv", { method: "POST", body: form });
            if (!infoRes.ok) {
                alert("Lỗi upload");
                return;
            }

            const info = await infoRes.json();
            currentFilename = info.filename;
            totalRows = info.rows;

            document.getElementById("fileInfo").innerText =
                `File: ${currentFilename} — ${totalRows} hàng.`;

            document.getElementById("previewSection").style.display = "block";
            document.getElementById("csvHead").innerHTML = "";
            document.getElementById("csvBody").innerHTML = "";
            loadedUntil = 0;

            await loadChunk();
        });

        async function loadChunk() {
            if (!currentFilename || loading) return;
            if (loadedUntil >= totalRows) return;
            loading = true;
            const res = await fetch(`/load-csv-chunk?filename=${encodeURIComponent(currentFilename)}&start=${loadedUntil}&size=${CHUNK_SIZE}`);
            if (!res.ok) { loading = false; return; }
            const json = await res.json();
            appendRows(json.data);
            loadedUntil = json.end;
            loading = false;
        }

        function appendRows(rows) {
            if (!rows || rows.length === 0) return;
            const thead = document.getElementById("csvHead");
            const tbody = document.getElementById("csvBody");
            if (thead.children.length === 0) {
                const tr = document.createElement("tr");
                Object.keys(rows[0]).forEach(k => {
                    const th = document.createElement("th"); th.innerText = k; tr.appendChild(th);
                });
                thead.appendChild(tr);
            }
            rows.forEach((row, idx) => {
                const tr = document.createElement("tr");
                tr.dataset.rowIndex = (loadedUntil + idx);
                Object.values(row).forEach(val => {
                    const td = document.createElement("td"); td.innerText = val; tr.appendChild(td);
                });
                tr.addEventListener("click", async function () {
                    const index = parseInt(this.dataset.rowIndex);
                    await fillFormFromIndex(index);
                    [...this.parentElement.querySelectorAll("tr")].forEach(r => r.classList.remove("selected"));
                    this.classList.add("selected");
                    document.getElementById("predictForm").scrollIntoView({ behavior: "smooth" });
                });
                tbody.appendChild(tr);
            });
        }

        const wrapper = document.getElementById("tableWrapper");
        if (wrapper) {
            wrapper.addEventListener("scroll", function () {
                if (wrapper.scrollTop + wrapper.clientHeight >= wrapper.scrollHeight - 80) {
                    loadChunk();
                }
            });
        }

        async function fillFormFromIndex(index) {
            if (!currentFilename) return;
            const res = await fetch(`/get-row?filename=${encodeURIComponent(currentFilename)}&index=${index}`);
            if (!res.ok) { alert("Không lấy được dòng"); return; }
            const row = await res.json();

            const featureNames = [
                "searched", "in_cart", "in_favorite", "unit_price",
                "original_price", "discount_rate", "rating_average", "review_count",
                "is_top_brand", "is_freeship_xtra", "quantity_sold", "has_buynow",
                "day_ago_created", "qty_clicks"
            ];

            featureNames.forEach(fn => {
                const el = document.getElementsByName(fn)[0];
                if (el) {
                    if (row.hasOwnProperty(fn)) el.value = row[fn];
                    else {
                        const found = Object.keys(row).find(k => k.replace(/\s+/g, '_').toLowerCase() === fn.toLowerCase());
                        if (found) el.value = row[found];
                    }
                }
            });
        }

        document.getElementById("predictForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            // convert to numbers
            Object.keys(data).forEach(k => {
                const n = Number(data[k]);
                data[k] = isNaN(n) ? data[k] : n;
            });

            const res = await fetch("/predict-product", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            if (!res.ok) {
                const err = await res.json().catch(() => ({ detail: res.statusText }));
                alert("Predict lỗi: " + (err.detail || res.statusText));
                return;
            }
            const json = await res.json();
            if (json.error) {
                document.getElementById("result").innerText = "Lỗi: " + json.error;
            } else {
                document.getElementById("result").innerText = "Khả năng mua: " + (json.probability * 100).toFixed(2) + "%";
            }
        });
    </script>

</body>

</html>